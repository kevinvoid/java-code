# 服务器性能指标-内存使用分析及问题排查

# 什么是内存
内存(Memory)也被称为内存储器，其作用是用于暂时存放CPU中的运算数据，以及与硬盘等外部存储器交换的数据。

程序运行时的数据加载,线程并发,I/O缓冲等等,都依赖于内存,可用内存的大小,决定了程序是否能正常运行以及运行的性能。

## 物理内存
物理内存指通过物理内存条而获得的内存空间。即随机存取存储器（random access memory，RAM），是与CPU直接交换数据的内部存储器，也叫主存(内存)。

## 虚拟内存
虚拟内存是计算机系统内存管理的一种技术。它使得应用程序认为它拥有连续可用的内存（一个连续完整的地址空间），
而实际上，它通常是被分隔成多个物理内存碎片，还有部分暂时存储在外部磁盘存储器上，
在需要时进行数据交换（也就是说，当物理内存不足时，可能会借用硬盘空间来充当内存使用）。
与没有使用虚拟内存技术的系统相比，使用这种技术的系统使得大型程序的编写变得更容易，对真正的物理内存（例如RAM）的使用也更有效率。

## Swap分区
Swap分区（即交换区）在系统的物理内存不够用的时候，把硬盘空间中的一部分空间释放出来，以供当前运行的程序使用。
那些被释放的空间可能来自一些很长时间没有什么操作的程序，这些被释放的空间被临时保存到Swap分区中，
等到那些程序要运行时，再从Swap分区中恢复保存的数据到内存中。

# 查看内存使用情况
## free
free命令可以显示Linux系统中空闲的、已用的物理内存，swap分区以及被内核缓冲区内存。
```
[root@iz2ze88p52tbimsqsq3canz ~]# free
              total        used        free      shared  buff/cache   available
Mem:        1883492      417328      149796         356     1316368     1266092
Swap:             0           0           0
```
一共有3行6列数据，行数据的意义如下： 
Mem 行是内存的使用情况。 buffers/cache 行是物理内存的缓存统计情况。 Swap 行是交换空间的使用情况。

### Mem
展示物理内存的整体情况

Total：表示物理内存总大小。
Used ：表示总计分配给缓存（包含buffers 与cache ）使用的数量，但其中可能部分缓存并未实际使用。
Free ：表示未被分配的内存。
Shared：共享内存，一般系统不会用到。
available：可用内存大小。

> total = used + free + buff/cache

### Swap行
Total：Swap内存总大小。
Used ：表示已分配的Swap大小。
Free：表示未被分配的内存。

### buffer与cache的区别
buffers 就是存放要输出到disk（块设备）的数据，缓冲满了一次写，提高IO性能（内存 -> 磁盘）。
cached 就是存放从disk上读出的数据，常用的缓存起来，减少IO（磁盘 -> 内存）。

buffer 和 cache，两者都是RAM中的数据。简单来说，buffer是即将要被写入磁盘的，cache是被从磁盘中读出来的。

### 命令参数
-m 以M为单位显示内存
-g 以G为单位显示内存
-s 2持续的观察内存的状况，每隔2秒打印一次

# Java Web应用内存占用飙高排查思路
JVM以一个进程（Process）的身份运行在Linux系统上。

一般在应用启动时都可以通过JVM参数来设置JVM内存的大小。如果超过这个限制就会抛出异常。所以，我们比较常见的内存占用过高问题，最显著的现象就是抛出各种OutOfMemoryError。

有一种可能导致直接内存，也就是Linux的物理内存过高的情况，就是NIO的使用。NIO引入了一种基于通道与缓冲区的IO方式，
他可以使用Native函数库直接分配堆外内存，然后通过一个存储在Java堆中的DirectByteBuffer对象作为这块内存的引用进行操作。
所以，在使用NIO的时候，要特别小心，避免导致机器内存被挤满

导致JVM中内存占用飙高的原因可能有很多。最常见的就是内存泄露。

## 内存泄露排查思路
1. 使用top命令，查看占用内存较高的进程ID。
2. 使用jmap查看内存情况，并分析是否存在内存泄露。
```
jmap -heap 3331：查看java 堆（heap）使用情况

jmap -histo 3331：查看堆内存(histogram)中的对象数量及大小

jmap -histo:live 3331：JVM会先触发gc，然后再统计信息

jmap -dump:format=b,file=heapDump 3331：将内存使用的详细情况输出到文件
```
得到堆dump文件后，可以进行对象分析。如果有大量对象在持续被引用，并没有被释放掉，那就产生了内存泄露，就要结合代码，把不用的对象释放掉。