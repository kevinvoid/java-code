# 服务器性能指标-CPU利用率分析及问题排查
Linux的负载高，主要是由于CPU使用、内存使用、IO消耗三部分构成。任意一项使用过多，都将导致服务器负载的急剧攀升。
本文就来分析其中的第二项，CPU的利用率。主要涉及CPU利用率的定义、查看CPU利用率方式、CPU利用率飙高排查思路等。

## CPU利用率
CPU利用率，又称CPU使用率。顾名思义，CPU利用率是来描述CPU的使用情况的，表明了一段时间内CPU被占用的情况。
使用率越高，说明你的机器在这个时间上运行了很多程序，反之较少。使用率的高低与你的CPU强弱有直接关系。

很多人都知道，现在我们用到操作系统，无论是Windows、Linux还是MacOS等其实都是多用户多任务分时操作系统。
使用这些操作系统的用户是可以“同时”干多件事的，这已经是日常习惯了，并没觉得有什么特别。 
但是实际上，对于单CPU的计算机来说，在CPU中，同一时间是只能干一件事儿的。为了看起来像是“同时干多件事”，
分时操作系统是把CPU的时间划分成长短基本相同的时间区间,即"时间片"，通过操作系统的管理，把这些时间片依次轮流地分配给各个用户使用。 
如果某个作业在时间片结束之前,整个任务还没有完成，那么该作业就被暂停下来,放弃CPU，等待下一轮循环再继续做.此时CPU又分配给另一个作业去使用。 
由于计算机的处理速度很快，只要时间片的间隔取得适当,那么一个用户作业从用完分配给它的一个时间片到获得下一个CPU时间片，中间有所"停顿"，
但用户察觉不出来,好像整个系统全由它"独占"似的。

而我们说到的CPU的占用率，一般指的就是对时间片的占用情况。

使用uptime 、top 、w 等命令可以在Linux查看系统的负载情况。其中，top 命令也可以用来查看CPU的利用率，除此之外，还可以使用vmstat 来查看cpu的利用率。 

## vmstat命令
vmstat命令是最常见的Linux/Unix监控工具，可以展现给定时间间隔的服务器的状态值,包括服务器的CPU使用率，内存使用，虚拟内存交换情况,IO读写情况。
```
procs  -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs   us sy id  wa st
 2  0      0 147604 172224 1143644  0    0     0     1    2    2    0  0 100  0  0
```
从上面的结果中我们可以看到很多信息，我们本文重点关注下cpu部分的指标。
1. %us：用户进程执行时间百分比，us的值比较高时，说明用户进程消耗的CPU时间多，但是如果长期超50%的使用，那么我们就该考虑优化程序算法或者进行加速。
2. %sy：内核系统进程执行时间百分比，sy的值高时，说明系统内核消耗的CPU资源多，这并不是良性表现，我们应该检查原因。
3. %id：空闲时间百分比
4. %wa：IO等待时间百分比，wa的值高时，说明IO等待比较严重，这可能由于磁盘大量作随机访问造成，也有可能磁盘出现瓶颈（块操作）
5. %st：虚拟 CPU 等待实际 CPU 的时间的百分比

一般vmstat工具的使用是通过两个数字参数来完成的，`vmstat 2 2`，第一个参数是采样的时间间隔数，单位是秒，第二个参数是采样的次数。

## top命令
top命令是Linux下常用的性能分析工具，能够实时显示系统中各个进程的资源占用状况，类似于Windows的任务管理器。

使用top命令，除了可以查看Load Avg以外，还可以显示CPU利用率信息。


## Java Web应用CPU使用率飙高排查思路
当发现系统的CPU使用率飙高时，首先要定位到是哪个进程占用的CPU较高。一般情况下，对于Java代码来说，导致CPU飙高可能由以下几个原因引起：
1. 内存泄露、导致大量Full GC（如典型的Java 1.7之前的String.subString导致的内存泄露问题） 
2. 代码存在死循环（如典型的多线程场景使用HashMap导致死循环的问题）

基本都是先定位到占用CPU较多的进程和线程，然后通过命令在查看这条线程执行情况。通过分析代码来定位其中的问题。